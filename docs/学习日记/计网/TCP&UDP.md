# TCP与UDP

## TCP

- Transmission Control Protocol 传输控制协议。

!> 面向连接的的协议，在收发数据之前必须先要建立三次对话。

### 特点

- 面向字节流、面向连接、传输可靠

> 保证可靠传输的方式

- 校验和
- 序列号
- 确认应答
- 超时重传
- 连接管理
- 流量控制
- 拥塞控制

#### 校验和

在数据传输的过程中，将发送的数据段都当做一个16位的整数。将这些整数加起来。并且前面的进位不能丢弃，补在后面，最后取反，得到校验和。

#### 确认应答与序列号

**序列号**：TCP传输时将每个字节的数据都进行了编号，这就是序列号。
**确认应答**：每次接受方收到数据后，都会对传输方进行确认应答。确认应答是上一次的序列号**加一**

#### 超时重传

因为确认应答机制，收发数据需要确认。
所有在没有收到确认时，会有一个等待时间，如果超时，那么就会重传，不论是丢包还是忘记返回确认号。

#### 流量控制

收发数据不能太快，因为接收方会有一个接收缓冲区，如果缓冲区满了，就会导致堵塞。
通过**滑动窗口**进行流量控制。

##### 滑动窗口

- 在TCP协议报头信息中，有一个16位字段的窗口大小，(2^16),代表接受方的缓冲区大小，这个是数字越大，代表接受方能接收更多数据，
网络吞吐率就越大。
- 接收方在发送确认应答时，会发送自己的（即时）的窗口大小，那么发送方就能更据这个数值来改变自己的发送速度。同时发送端也会定时向
接收端发送窗口探测数据端，从而获取窗口大小。
- 只有在收到滑动窗口的前n个连续的回复，即滑动的距离不能中断，才让窗口后移动。
例：
  segment 分段如下：
  |1 2 3 4| 5 6 7 8 9
  当前窗口为 1-4
  收到 2 3 的响应，此时不会滑动
  收到1的响应，滑动
  1 2 3 |4 5 6 7| 8 9

#### 拥塞控制

步骤：

- 慢开始
- 拥塞控制
- 快重传
- 快恢复

**ssthresh**:阈值。具体的看图

> 看下面的经典图：

![拥塞控制](https://gitee.com/gitme-H/images-bed/raw/master/img/拥塞控制.png)

### 为什么三次握手，四次挥手

> 因为当Server端收到Client端的SYN连接请求报文后，可以直接发送SYN+ACK报文。其中ACK报文是用来应答的，SYN报文是用来同步的。但是关闭连接时，当Server端收到FIN报文时，很可能并不会立即关闭SOCKET，所以只能先回复一个ACK报文，告诉Client端，"你发的FIN报文我收到了"。只有等到我Server端**所有的报文都发送完**了，我才能发送FIN报文，因此不能一起发送。故需要四步握手。

### 三次握手

第一次： client ----------> server
**客户端**发送 SYN = 1 同步号，seq = x 序列号

第二次： client <---------- server
**服务端**发送 ack = x+1, SYN = 1同步 SEQ = y

第三次： client ----------> server
**客户端**发送 SYN=0,ACK=1, ack = y+1, seq = x + 1

### 四次挥手

第一次：主动方 -----------> 被动方
FIN = 1,seq=X
主动方发送FIN+ACK报文，并发送序列号为X

第二次：主动方 <----------- 被动方
ack = X+1 SEQ = x+!
被动方发送ACK报文，并置发送号为X+1

第三次：主动方 <----------- 被动方
FIN = 1, ACK = 1, SEQ = Y,ack=x+!
被动方发送FIN+ACK报文，并置发送序号为Y，在确认号为X

第四次：主动方 ------------> 被动方
ACK=1,ack=Y+!,SEQ = X+!
主动方发送ACK报文，并置发送号为X，在确认号为Y

MSL(Maximum Segment Lifetime)
最大报文生存时间

## UDP

### UDP特点

1. UDP是无连接的，即发送数据之前不需要建立连接，减少了开销和发送数据之前的时延。
2. UDP使用尽最大努力交付，即不保证可靠交付，因此主机不需要维持复杂的连接状态表。
3. UDP是面向报文的，发送方的UDP对应用程序交下来的报文，在添加首部后就向下交付IP层。
4. UDP没有拥塞控制，网络出现阻塞时不会使源主机的发送速率降低，对于实时应用很重要。（ip电话、实时视频会议）。
5. UDP支持一对一、一对多、多对一、多对多的交互通信
6. UDP首部开销小

### UDP复用分用

- 复用：将应用程各个应用进程的数据报封装成不同的ip数据报，复用一个网络层协议。
- 分用：接收端收到3个ip数据报，提取首部的目的端口号，分发到不同进程。
